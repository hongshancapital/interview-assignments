# 方案设计

## 需求分析

轮播图属于典型状态机，在加载后存在以下几种状态：

1. 等待状态，完成后会自动进入切换状态
2. 切换（跳转）状态，完成后会自动进入等待状态
3. 暂停状态，完成后进入切换状态（跳转上一张，下一张，或者保留在当前）

> 难点分析：由于状态切换是异步的，一部分状态切换是自动的，一部分状态切换则是外部触发的，如拖拽、跳转。因此存在状态冲突情况

轮播图组件需求有以下几类特点：

1. 复用场景多。可能多个项目都会使用，甚至同一个项目多个页面会使用，但“实例”之间有很多不同，如，有的有可拖拽，有的有 dots（并支持跳转）等
2. 需求变化频繁。如数据源、动效参数等配置

这里有两种思路：1）实现 `Carousel` 最核心能力，其他通过插件来丰富其能力；2）实现 `Carousel` 全功能，使用配置约束其能力。

个人倾向于前者，其次整体上应该是两层封装。第一层封装应该是核心逻辑封装使得其具备跨项目能力；第二层封装应该基于需求阶段实现一部分扩展能力，最后由业务使用方传入配置即可。即一层逻辑封装，一层组件封装。

## 异步状态及冲突解决

主要存在自动状态切换和外部主动触发状态切换冲突。解决方式：

1. 避免异步完成后触发自动切换，可以考虑使用异步状态维护。如，fulfilled 自动切换，rejected 则不作处理
2. 状态切换和数据切换是异步的，即异步状态完成后才切换状态数据

## 程序设计

1. 使用状态机实现逻辑上的“轮播能力”，实现 UI 与逻辑解耦
2. 需要必要模板方法（如 jump/wait）实现核心 “UI” 逻辑
3. 使用插件机制实现定制能力和扩展能力，根据第二条可以约束至少使用一个插件实现核心 “UI” 逻辑

整体实现如下：

> 下图并没有说明状态转换关系，及 UI 与 状态 之间具体交互

```sh

  ┌──────────────────────────────────────────────────────────────┐
  │  StatusManager                                               │
  │     ┌────────────┐     ┌────────────┐      ┌────────────┐    │
  │     │    init    │     │    mounted │      │    pause   │    │
  │     │            │     │            │      │            │    │
  │     └────────────┘     └────────────┘      └────────────┘    │
  │                                                              │
  │                                                              │
  │     ┌────────────┐     ┌────────────┐       ┌────────────┐   │
  │     │   unmount  │     │   waiting  │       │  jump      │   │
  │     │            │     │            │       │            │   │
  │     └────────────┘     └────────────┘       └────────────┘   │
  │                                                              │
  └──────────────────────────▲────┬──────────────────────────────┘
                             │    │
                             │    │
                             │    │
                             │    │
                             │    │
  ┌──────────────────────────┴────▼──────────────────────────────┐
  │  UIFramework                                                 │
  │     ┌────────────┐     ┌────────────┐      ┌────────────┐    │
  │     │  animation │     │  drag/jump │      │    ...     │    │
  │     │            │     │            │      │            │    │
  │     └────────────┘     └────────────┘      └────────────┘    │
  │                                                              │
  └──────────────────────────────────────────────────────────────┘
```

### 插件设计

根据上述状态机描述，插件主要包含以下生命周期（hook）：

| hook      | description         | note                   |
|-----------|---------------------|------------------------|
| `init`    | async hook          | e.g. fetch source      |
| `mounted` | sync hook           | e.g. bind event        |
| `waiting` | async parallel hook | e.g. dots progress     |
| `jumping` | async parallel hook | e.g. dots progress     |
| `pause`   | sync hook           | rejecte current status |
| `unmount` | sync hook           | remove effect          |
