## 短域名服务说明

### 1、需求背景

撰写两个 API 接口:

- 短域名存储接口：接受长域名信息，返回短域名信息
- 短域名读取接口：接受短域名信息，返回长域名信息。

限制：

- 短域名长度最大为 8 个字符
- 采用SpringBoot，集成Swagger API文档；
- JUnit编写单元测试, 使用Jacoco生成测试报告(测试报告提交截图)；
- 映射数据存储在JVM内存即可，防止内存溢出；

### 2、需求分析

需求特点：

- 输入的字符串为域名连接（最大为2083字符，且需要满足Http或Https的格式）。
- 编码频率小于等于解码频率。
- 有限期的映射存储时间（不确定，此次设计为永久保存）。
- 由于使用http方式传输URL，使用RequestBody方式接受请求容错性能高。

需要解决的问题：

- 依据长域名生成短域名的方式
- 通过短域名查找长域名
- 维护彼此的映射关系，防止内存溢出
- 由于为缩减映射，会出现映射耗尽的情况

根据长域名生成为短域名大致有两种方式：

- 编号：为每个长域名进行编号，使用长域名的序号作为短域名使用
- 摘要：使用信息摘要算法对长域名进行计算，获取短域名的值

两种方法对比如下：

#### 2.1、编号

优点：

- 实现简单
- 能用尽所有短域名空间

缺点：

- 同一个长域名多次编码会对应多个不同的短域名，降低有效映射数量。
    - 可以额外维护一个长域名到短域名的映射。当编码长域名时，发现长域名存在，则直接返回对应短域名，但是会产生一倍的存储开销。
- 由于短域名有序，导致产生的短域名很有规律（不好看，而且会被猜到使用了多少长度）
- 回收映射资源会比较麻烦

#### 2.2、摘要

优点：

- 一个长域名多次编码，均会产生同一个短域名
- 生成的短域名无序（更安全，好看~）
- 更有利于回收映射资源

缺点；

- 空间利用率取决于摘要算法，难度较高
- 一般不能用尽短域名空间

**综合考虑，本项目采用“摘要“方式实现长域名到短域名的映射。**

#### 3、项目实现

使用HashMap作为映射池对映射关系进行存储，读取不加锁，写入加锁。 提供映射池最大值配置参数，当映射池中数据达到最大值时，给予错误提示。 使用统一的返回结构进行返回。 使用全局异常管理。

#### 3.1、编码设计

长域名编码时需要对输入字符串进行校验，将长域名编码为短域名后，若短域名存在，由于使用摘要算法，则还需比较当前短域名所对应的长域名是否为传入的长域名，否则肯导致多个长域名到短域名映射不匹配的问题。

详细流程见下图：

![长域名编码流程图](http://assets.processon.com/chart_image/62729945079129397f332032.png)

#### 3.2、解码设计

通过短域名查找长域流程见下图：

![短域名解码流程图](http://assets.processon.com/chart_image/62729ba51efad45d06d8ddfd.png)

#### 3.3、摘要算法设计

由于入参长度较小（2083字符）且为ASCII字符，直接将入参切分为字符 首先将每个字符与种子依次做异或操作，但是由于异或两次得到原值，直接异或只有单个字符的摘要，没有字符和字符间的摘要，会导致比较大的碰撞记录。
所有此处每个字符与种子异或后，再将种子与种子之间异或，这样即可极大增加摘要随机程度，实现牵一发而动全身的效果
实际测试对22031680个数字编码后未碰撞（设置的五千万长度的映射池，结果OOM了，大佬们可以跑满试试），测试代码见com.lenfen.short_domain.service.MoreDomainTest

摘要算法示意见下图：
![摘要算法流程说明](http://assets.processon.com/chart_image/62729d55f346fb6712b8f0bd.png)

由输出为短域名，则单个字符的输出域的大小为52（42个大小写字符+10个数字） 由于异或后可能为负数，需要将最终的种子与0xFF做与运算，使结果保持正数。最终将每个因子对52取模，再转换为对应的字符返回。

### 4、测试覆盖度

测试用例覆盖度见下图
![测试覆盖](./public/jacoco.png)

### 5、压测

可以使用 jmeter 对接口进行压测，设置多个用户组，配置HTTP请求，加上图形结果树。

### 6、其他

能想到的场景是有限的，可能会存在一些没考虑到的场景，如果有啥BUG，或者可以优化的地方，希望大佬能不吝赐教。

本人乐观开朗，学习能力强。希望可以与专业、幽默、有活力的团队一同共事。 简历见: ./public/陈天洋的简历.pdf




