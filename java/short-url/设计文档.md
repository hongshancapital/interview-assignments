## 1 需求分析

### 1.1原始需求

撰写两个 API 接口:

- 短域名存储接口：接受长域名信息，返回短域名信息
- 短域名读取接口：接受短域名信息，返回长域名信息。

约束：

- 短域名长度最大为 8 个字符
- 采用SpringBoot，集成Swagger API文档；
- JUnit编写单元测试, 使用Jacoco生成测试报告(测试报告提交截图)；
- 映射数据存储在JVM内存即可，防止内存溢出

## 2 整体设计

### 2.1设计思路

​        首先，需要意识到不存在一种能够将任意输入的长字符串A转换成定长的短字符串B，同时又能将B通过对偶的算法还原为原始长串A的算法（相当于压缩解压算法，但是目前没有压缩算法能压缩到定长）。因此程序必须将长域名对应的短域名进行对应的缓存。因此原需求可以被划分为两个子问题：

1、通过某种算法，将长域名转换为短域名。（从而满足第一个API接口的要求）

2、存储长短域名的映射关系。（为满足第二个API接口的要求）



### 2.2 功能点分解

从前面的分析知，问题被分解为如下2个子需求

1、通过长域名生成短域名

2、存储域名映射

#### 2.2.1 短域名生成方案

短域名生成方案有多种，

1、基于摘要算法：

​        这种算法通过摘要算法（例如MD5），对输入的长域名进行摘要处理，得出定长的摘要串，再进行处理。计算过程中可能出现碰撞（概率很小），可表达的url数量为62的5次方或6次方（根据摘要长度确定）。

2、基于随机数：

​       该方法是从62个字符串中随机取出一个6位短码的组合，然后去数据库中查询该短码是否已存在。如果已存在，就继续循环该方法重新获取短码，否则就直接返回。 

2、基于自增id：

​       这种算法实现比较简单，碰撞的可能性为0，可表达的URL可达无穷大，长度可以从1开始。 

这里选用自增序列方案。

#### 2.2.2 域名映射存储方案

长短域名映射的存储，有如下几种方案（按提议，仅考虑内存缓存，不考虑数据库或者redis之类缓存，更不考虑分布式场景）

1、基于ConcurrentHashMap缓存

2、基于JDK容器经行二次开发，自己实现缓存。

3、基于Caffeine/ehcache缓存

选型：

基于ConcurrentHashMap缓存，无法对缓存大小做出限制，导致潜在OOM风险。方案1 舍弃。

在没有合适的开源三方缓存的时候，可以考虑方案二，这里不考虑。

 方案3中，Caffeine的性能比ehcache更好，并且它使用了更加优秀的缓存淘汰策略，提供接近理想的命中率，因此选择Caffeine

### 2.3 业务流程设计

在域名映射存储选择方案3的前提下，可以初步得到如下2个流程图

![1651667510052](images\1651667510052.png)

进一步的考虑：

是否有必要存长域名到短域名的映射？

如果按照上面流程图处理，在判断缓存中是否存在长域名对用的短域名时就需要有一个 longUrlToShrotUrlMap。

但是考虑到实际使用场景，即使不做判断，单个长域名多次作为入参，生成多个短域名与其对应，实际上对功能也是无影响的。因为应用场景最终关心的是，通过短域名是否得到长域名，而老的（冗余的）短域名最终可以通过缓存的过期策略进行自动清除。因而最终我们可以设计这样的简化流程：

![1651669052008](images\1651669052008.png)



## 3 详细设计



### 3.1 接口设计

​         如果将接口类型设为GET，由于入参本身是个URL，因此会涉及URL的encoding和decoding，影响开发和使用的效率。因此在此将2个API都设置为POST，在body中传入URL参数，无需encoding和decoding。

​        接口设计如下：

#### 3.1.1 get-short-url接口

```txt
POST /short-url/get-short-url
```

body样例：

```txt
https://github.com/scdt-china/interview-assignments/pull/1031/commits/634f9848ddbffd1711030425ead043619e7c9150#diff-efc311c566107eab26668d2cbac5066122a9b1bb1df0d82225913b23f6d1e4b9
```

响应样例：

```txt
lsXF
```



#### 3.1.2 get-long-url接口

```txt
POST /short-url/get-long-url
```

body样例：

```txt
lsXF
```

响应样例：

```txt
https://github.com/scdt-china/interview-assignments/pull/1031/commits/634f9848ddbffd1711030425ead043619e7c9150#diff-efc311c566107eab26668d2cbac5066122a9b1bb1df0d82225913b23f6d1e4b9
```


