# SdnsDemo--短域名服务

## 主要功能

实现了两个对外服务的 API 接口:
- 短域名存储接口：接受长域名信息，返回短域名信息
- 短域名读取接口：接受短域名信息，返回长域名信息。

###技术要求: ：
- 短域名长度最大为 8 个字符
- 采用SpringBoot，集成Swagger API文档；
- 映射数据存储在JVM内存即可，防止内存溢出；

## 功能分解
    本程序主要实现了保存用户提交长域名并转为短域名和用户提交短域名请求后自动跳转到之前提交长域名中。
    用例1: 用户输入经过校验合法的长域名信息，服务端后转换、存储成短域名信息并返回。
        任务1:接受长域名信息录入并校验其合法性。
        任务2:使用域名压缩算法获得短域名。
        任务3:保存尚未保存的长域名对短域名，短域名对长域名映射信息。
    用例2: 用户输入经过校验合法的短域名信息，服务端返回长域名信息
        任务1:接受用户端短域名信息录入及输入合法性校验
        任务2:通过短域名查询已保存的长短域名对应信息，并返回长域名。
## 设计思路
    1.  原则：敏捷、简约、有效、可靠、随业务发展
    2.  对于短域名存储接口:
        2.1 接收到用户传过来的长域名参数后，首先进行合法性校验。
        2.1 校验通过后用MD5进行HASH取值，然后把这个HASH值和系统固定的长转短的前缀拼在一起作为【长转短KEY】。
        2.3 用把【长转短KEY】在内存数据库中进行一次查询，如果能查到就立即返回。
        2.4 如果不能查到，就加锁后再进行一次查询，如果能查到就立即返回。
        2.5 如果还是不能查到的话，调用短域名生成算法生成短域名，调用内存数据库【长转短KEY】和短域名进行匹配并存储，
            同时也对【短转长KEY】以及长域名进行匹配并存储，然后返回生成的短域名。
    3.  对于短域名读取接口:    
        对于短域名读取通过过滤器直接进行跳转
        3.1 分析URL请求，如果域名中包没有含有本系统生成的短域名标志，就把请求往下传递。
        3.2 如果包含本系统的短域名标志，就从内存数据库中查询长域名，如果长域名存在，把response的状态设为302，
            并在Header中Location参数设为改长域名，返回。
            （在本次实现中采用了HTTP302状态码是为了减少客户再做跳转，也可以改为参数的方式返回）
        3.3 如果长域名不存在，设置提示信息返回
   
### 细节再优化的方案
       对于2.1  如果在实际运营中发现HASH冲突超出期望值，可以调整为SHA算法，或者其他HASH算法。
       对于2.5. 如果获取短域名延迟较大时，可以在生成短域名后立即返回端域名，调用异步接口进行域名匹配的存储。 
       对于数据可持久化，由于需求要求采用内存，没有做数据持久化，后续可以外接Redis作为缓存数据库
   
## 细微亮点
    1. 本系统基于支持高并发的ConcurrentHashMap模拟了一个内存数据库，设计了对过期数据自动处理及数据超容后的处理机制。 
    2. 本系统短码为64个字符组成，按最长8位计算的话，理论上可以管理281万4749亿短域名，
       而且这个数量的控制可以通过调整内存数据库的一个参数进行控制。
    2. 在短域名存储的接口中，通过先不加锁从内存数据中取既有的办法，既可以提供系统性能，也可以预防攻击。

## 架构设计
    采用经典的分层架构，以高内聚低耦合、职责单一的原则。尽力保证后续需求变化中核心功能良好的易扩展性以及基础设施的易替代性。
    从而降低企业成本，提高研发效率。 逻辑层分为过滤器、控制层、服务层、数据层。如下图所示
![架构设计图](https://github.com/603e/interview-assignments/tree/master/java/SdnsDemo/README_IMG/framework.png)

###项目结构

```
SdnsDemo
├──README_IMG                   说明文档里使用到的图片
├──src
    ├──main
        ├──java
            ├──city.yyds.job.hsdemo
                ├──config       定位系统配置的bean
                ├──controller   控制层
                ├──filter       过滤器
                ├──mdb          内存数据库
                ├──service      服务层
                ├──utils        工具类
        ├──resources            存放配置文件
    ├──test
        ├──java
            ├──city.yyds.job.hsdemo
                ├──controller   控制层测试类
                ├──filter       过滤器测试类
                ├──mdb          数据层测试类
                ├──pref         性能测试类
                ├──service      服务层测试类
├──pom.xml                      pom文件
├──README.md                    说明文档（即本文档）

```
## 单元测试：
![单元测试覆盖率图](https://github.com/603e/interview-assignments/tree/master/java/SdnsDemo/README_IMG/test_case_cover.png)
从上述测试结果来看指令行覆盖率为99%，分支覆盖率为100%。由此可得测试覆盖率是能满足要求的。

## 性能测试:
    本次利用Java性能测试框架工具-JunitPerf进行测试，测试结果如下：
![性能测试图](https://github.com/603e/interview-assignments/tree/master/java/SdnsDemo/README_IMG/pref.png)    
从图中可以得出最小延迟为99毫秒，最大延迟为128毫秒，平均延迟为109毫秒。同理，性能也是能满足要求。
## 编译运行
  编译后取启动类jar包即可命令行启动
  启动命令：java -jar java -jar -Xms2048M -Xmx2048M -Xmn512M -Xss256k -XX:PermSize=512M  SdnsDemo-0.0.1-SNAPSHOT.jar<br>
  swagger地址： http://localhost:8080/swagger-ui.html
 <br>
 
***注：由于最近恰好赶上系统上线工作繁杂、时间仓促，只是以DEMO的方式验证了思路，还有很多地方值得优化和完善。<br>
不足之处误之处，请不吝赐教。希望能有进一步面试的机会。当面详解，谢谢。<br>
提交人：刘领献 联系电话:13488826608（微信同号） ***
      


