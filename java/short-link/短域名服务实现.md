# 1.设计思路

看完需求之后，我的脑海里面闪现出了短域名服务几个核心问题：

1.长域名如何转换为短域名？

2.已经转换过的长域名如何快速的查询到对应的短域名？

3.短域名如何快速的查询到原始长域名？

4.短域名的长度以及过期限定的问题如何处理？

### 1.1 长域名如何转换为短域名？

第1个问题，长域名转换为短域名，我想到方案，有压缩方案和映射方案可选。

单纯的字符串压缩，很显然难以控制长度，可以pass了，摘要压缩的方案倒时可以考虑，例如先使用MD5算法对长域名做摘要压缩，然后再对MD5分段处理，这样可以控制长度，不过短期内有可能生成相同的短域名，导致上一个短域名生存周期很短，生成周期不可控，不作首选方案。

> MD5方案详情：
>
> 以下以生成1个3位长度短字符串为例，如果短字符串长度要求不一样，可以基于此做相应调整。
>
> 1.将长链接生成32位MD5字符串；
>
> 2.对这32位字符串取其中8个字符, 将它看成16进制字符串，与0x3FFFFFFF(30位1)的位与操作，会将超过30位的数字忽略处理，得到一个30位16进制的字符串；
>
> 3.将这30位又分成3段，每10位的数字作为字母表的索引取得特定字符，依次进行获得3位字符串(把得到的值与 0x0000003D 进行位与运算，取得字符数组 chars 索引，把取得的字符相加，每次循环按位右移 10 位
>
> 4.把每段取到的字符串联起来，就可以得到一个3位长度的短字符串。
>
> 大致过程如下图所示



![image-20211215144232270](images\image-20211215144232270.png)



那可以考虑映射方案，映射方案我想到的大体有3种：

第1种方案，生成UUID，然后对UUID做分段处理，跟MD5方案类似，生成短域名性能比MD5方案要稍好一些，考虑到查询时还是可能需要生成MD5，性能整体跟MD5方案差不多，同时存在在短期内生成相同的短域名，生成周期不可控的缺点。方案细节可以参考MD5。

第2种方案，基于自增数62进制转换，只需要一个全局唯一的自增序列器即可，生成全局唯一自增序列数，进行62进制压缩，得到一个短字符串，然后建立短字符串和长域名的映射关系即可。

![image-20211215170605535](images\image-20211215170605535.png)

全局唯一自增序列器可以借助Redis，MySQL或者程序生成。我自己会比较倾向于基于自增数62进制转换生成短域名。避免了MD5方案和UUID方案的生成周期不可控的问题。



### 1.2 已经转换过的长域名如何快速的查询到对应的短域名？

第2个问题，因为长域名可能比较长，直接建立映射关系，性能可能不够好，所以我们可以考虑先对长域名进行Hash摘要处理，生成一个相对短一些的字符串，然后建立这个相对短一些的字符串到短域名的映射，这里跟进需要还可以加上布隆过滤器来查询是否存在，如果需要进行数据库查询的情况下，可以考虑加。



### 1.3 短域名如何快速的查询到原始长域名？

第3个问题，我们可以通过Hash表，Redis，MySQL存储短域名和原始长域名的映射关系，这样基于查询的数据结构的支持，查询就可以很快。



### 1.4 短域名的长度以及过期限定的问题如何处理？

第4个问题，我们可以在长度超过限定长度的时候，调整全局唯一的自增序列器重新开始自增，或者跟进长度计算出一个较大的数，对这个数取余，保证长度在限定范围之内。短域名过期的问题，我们可以在自增序列器重新开始自增时，对覆盖的长短域名都做过期处理，相对来说，过期周期比较有规律，当然也可以有一些过期策略，例如，近期不访问的优先过期或者访问频率低的优先过期等等，不过需求里面没有要求，由于长度的优化，会在自增序列器重新开始自增时，过期最早的长短域名信息。



# 2.架构设计图

基于以上分析，一个大致的架构设计图就出来了。不过考虑到需求里面映射数据存在JVM里面，所以Redis和DB都不会被使用到，我们只需要对这个设计图稍微一些调整即可，把缓存设置为内存，不持久化即可。

![image-20211215153825118](images\image-20211215153825118.png)

### 2.1 长域名存储接口流程图

![image-20211215155357198](images\image-20211215155357198.png)

2.1.1 根据长域名生成MD5摘要

2.1.2 使用生成的MD5在内存映射关系里面查询是否存在对应的短域名信息，如果存在，直接返回即可

2.1.3 如果不存在，就要准备生成全局自增序列数了，这里需要考虑多线程并发的线程安全问题

2.1.4 将自增序列数压缩转为短字符串，进行拼接后生成短域名，这里需要考虑短域名长度限制问题

2.1.5 保存MD5到短域名以及短域名到长域名的映射关系

### 2.2 短域名读取接口流程

![image-20211215161345815](images\image-20211215161345815.png)

2.2.1通过短域名从内存映射关系里面查询对应的长域名信息是否存在，如果存在，直接返回即可，如果不存在，返回错误信息。
