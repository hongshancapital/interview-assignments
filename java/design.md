# 短域名需求设计#
## 需求目标
实现短域名服务，提供两个接口
1.存储接口：接受长域名信息，返回短域名信息
2.读取接口：接受短域名信息，返回长域名信息
## 需求使用场景分析
短域名服务主要用于信息推广。推广方把长RL转换为一个短URL后转发给目标客户，客户拿到短URL后，能够访问到实际的长URL。其常见的使用场景有短信，邮件推广，社交网络分享。短域名服务让内容精简有力，屏蔽关键词，提高用户体验。同时短信，社交网络一般有字数限制，通过短域名可以减少字数。
通过需求分析可以得到两个接口的要求：
读取接口要求：
1. 速度快：访问速度越快越好，用户访问短链接后，应该迅速访问到实际的内容，超过一定时限会导致用户流失
2. 唯一性：对于一个指定的短URL，读取的长URL必须是唯一的。

存储接口的要求：
1. 保证客户在可接受时间内拿到自己长URL对应的短链接
2. 在客户可接受时间内，对于指定的长URL，生成的短URL尽量保证唯一

现在我们有了两个接口的需求期望，现在进行技术选型

## 技术方案
### 前置条件
1. 该试题采用的是单机环境，所有数据存在内存当中且内存有限
2. 短URL最长为8个字符
3. 实际场景的短域名，提供的短URL数量不会用尽（用62进制，8字符最多可以表示有62^8个请求数量）。由于是单机环境，本题配置最大短URL数量，短域名请求数量超过后，返回默认值
4. 安全性限制：本题将限制单个长URL的最大长度。原因是浏览器有URL最大长度限制，同时超长的URL一般是带参数搜索类URL，一般不会使用到短URL场景中

###短URL生成策略
1. 生成算法：由于短URL-长URL映射必须要满足唯一性，为了避免碰撞，我们可以使用常见的排号算法，对于每来一个请求，计数器+1，这种短URL生成算法复杂度为O（1）
2. 唯一性：短URL最长为8个字符。如果采用62进制表示，我们最多对可以对62^8亿个长URL进行编码，如上一节所说，不可能出现短URL用尽的情况。
3. 并发性：使用atomiclong 数据自增保证唯一。假定长URL的长度最小值都是8，无论是32位机还是64位机，其表达的url集合大小都是约等于内存。在我们的前置条件3情况下，ID不可能出现溢出

###数据存储和读取策略，以及性能调优：
1. 性能调优： 使用两个HASHMAP存储长URL-》短URL映射关系，和短URL-》长URL映射关系，保证存储接口和读取接口的性能。HASHMAP插入和读取数据的复杂度是O(1)，且短URL生成策略是O(1)，这种情况下，存储接口和读取接口性能都是O(1)
2. 并发性数据准确性：我们采用发号策略，新插入的短URL不会重复，且因为前置条件3，本题中两个hashmap都不会出现多对一的情况，本期中除了发号需要考虑并发，其他场景不需要考虑并发下数据是否有误。
3. 内存空间优化：两个map key-value存储的都是引用，实际上内存中只需要长短URL的一个copy，基本最优。 另外如果将短URL id作为数组下表，使用数组存储短URL-》长URL存储关系能少量提升性能和节约内存，但是该方式较为复杂，不够简单，本题为了简化方案，还是决定都是用HASHMAP。
4. 避免内存溢出：两个方案。方案一是限制长URL请求的数量，运维通过可用内存除以URL最大长度计算出最大数量后，进行配置。方案二是单独起一个线程，监控剩余内存，如果内达到极限，就拒绝存储服务。本题使用方案一，优点是实现方便，缺点可能是会有一定的内存浪费。

### 代码实现：
 规格：使用springboot实现，用户需要配置长URL最大长度，最多可提供的短URL数量。
 
 存储接口代码流程：
	    输入：长URL请求
	    1. 长URL长度大于限制长度，直接返回空值
	    2. 查询map, 如果之前已经有类似的长URL请求，返回之前存储的短URL
	    3. 发号ID超出配置的短URL最大数量，直接返回默认值 "ZZZZZZZZ"
	    4. 发号ID自增1，转换为62位进制String，存储到map中
	    5. 返回生成的短URL
读取接口代码流程：
	   输入：短URL请求
	   1. 短URL如果包含非法字符，或者长度 > 8, 直接返回空值
	   2. 在MAP中查询短URL，如果查询不到对应的短URL-》长URL映射，直接返回空值，否者返回对应的长URL

## 测试方案设计
最好能有一个mock类和mock database，存储各种长url和短url映射数据。由于时间有效，本题中不写mock类了，只写了测试用例
### 存储接口测试用例
1. 参数合法性用例：长URL长度>指定长度或者长URL为空时，返回空值
2. 唯一性用例：多次相同的长URL，获取的短URL必须相同。不同的长URL请求，获取的短URL不同
3. 结果合法性：获得的短URL必须由数字和字母组成，且长度不能超过8
4. 并发性测试：多线程重复实例1,2,3，得到的结果要相同
5. 最大能力用例：长URL请求超过一定的数量后，返回指定的默认短URL
6. 内存保护：运维配置完长URL最大长度，且短URL最大提供数量后，运行到最大值后，不会出现内存溢出

### 读取接口测试用例
1. 参数合法性用例：短URL长度>指定长度，或者包含不支持字符，返回空值
2. 唯一性测试：发出一定数量（不超过规格）的不同长URL请求后。使用获得的短URL查询对应的长URL，得到的长URL必须要和原始值相同
3. 结果合法性测试：发出一定数量（不超过规格）的不同长URL请求后。查询一个超出自增ID之外的短URL，得到的长URL为空
4. 多线程重复用例1,2,3，得到相同的预期结果


### 系统性能测试方案：
 限制条件：本人只有两台PC，只能一台用于server，一台用于client，无任何扩容手段，只能测试单机的服务性能

####  存储接口测试用例：
1. 最大提供的短URL数量：测试方法client一直向server发起不同的长url请求，server返回默认的拒绝服务短URL后，计算长URL请求数量
2. 单位时间内能够提供的短URL数量：client 在1min内无间断发起长URL请求，完毕后，使用长URL请求数量除以时间
3. 最大并发量：client启动多线程（线程数量逐步上升）连接sever，发起长url请求，使用线程开始超时的线程数量作为结果

#### 读取接口测试用例
首先调用存储接口存放映射关系，直到达到短URL服务数量最大值
1. 单位时间内能够查询的短URL数量：client 在1min内无间断发起短URL请求，完毕后，使用请求数量除以时间
3. 最大并发量：client启动多线程（线程数量逐步上升）连接sever，发起短url请求，使用线程开始超时的线程数量作为结果

## 遗留问题：
1. 安全：本题采用id发号，生成的短URL是可预测的，且发号方法容易被破解。后续可以考虑进行一定范围的随机发号
2. 没有考虑请求负载均衡
3. 内存存储，发号策略的负载均衡和并发性都是针对单机环境定制，需要考虑可扩展性
4. 用户友好性：短URL可能会全部为数字，不够友好。考虑后续只用字母表示，去掉数字
