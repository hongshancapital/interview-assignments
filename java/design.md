# 1. 设计思路 文档：完整的设计思路、架构设计图以及所做的假设(Markdown格式)
## 1.1 说明
  从技术原理上说，将一个长网址转换到短网址，和从短网址转换到长网址，需要解决两个问题：长短字符串短映射以及映射关系的存储。
  
  字符串短映射是字符串编码问题，需要考虑字符串映射之后的重复问题，需要从技术上或者从概率上将此问题降低到最低。
  
  映射关系的存储维护，可以使用map在jvm内存内存储，或者使用内存数据库将关系存储下来。
  
## 1.2 实现方案
- 长短字符串映射
长字符转换到短字符串会有字符串失真问题，这里考虑通常短做法，将长字符串短hash值映射到常用字符上，常用字符包括数字0~9，小写字符a~z，大写字符A~Z，共62个字符。通过将长字符的hash值映射到62进值的数值上，从而可以表示为6位的字符串，而将计算时的秒级时间戳映射到62进制数值，取最后两位加到字符串短后两位上，组成共8位的短字符串为结果。
这种方式，短字符串短可能性为62^8，重复率几乎可忽略。
- 映射关系存储
本方案选择使用redis内存数据库存储，在实现上比jvm内维护map更不容易导致内存溢出，且实现过期时间会更容易。

# 2 架构设计图
见图design.png

# 3 假设
- 基于此方法的字符串映射，在短时间（expireTime）内，不会产生重复的短字符串网址，即在一定的过期时间之内，短网址重复的小概率事件不会发生
- 系统掉电导致内存数据清空或者出现脏乱数据问题，需要清空redis，将之前生成的短网址全部生效，或者有高可用性需求的，可以部署redis集群
- 未考虑短时间大量长网址情况，如有此需求，需要考虑双向map，避免大量冗余数据侵占内存。实际上，当expireTime设置的数值在一个合理范围时，可以降低此种情况（除恶意攻击）带来的影响
- 未考虑短网址的时限限制，需要结合具体需要，看是否需要在访问短网址之后给以续时，以保证短网址可用性。

# 4 性能测试
使用jmeter进行接口压测，分别测试10/100/1000并发下存储和查询接口的qps。
经测试，吞吐量均为9500/s左右， 并无明显波动。
