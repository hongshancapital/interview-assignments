## 背景

过长的链接在短信、微博等内容长度受限的平台中不够友好, 由此短链接的需求产生。短域名服务主要是用来处理长短链接的映射。

## 方案设计

### 短链长度

当前互联网网页总数数十亿(参考[http://www.worldwidewebsize.com](http://www.worldwidewebsize.com)), 题中要求短链长度最大为8个字符, 使用62进制最大能表示 62<sup>8</sup>=218340105584896个网址, 远远够用, 此处可以空出一个字符作为扩展位, 62<sup>7</sup>=3521614606208~=35216亿也足够了。

此处采用7个字符存储短链, 最后一个字符用默认值填充预留的方式设计短链。

### 算法分析

如何生成短链, 比较流行的算法有两种: 自增序列算法、摘要算法。

#### 自增序列算法

设置id自增, 一个10进制id对应一个62进制的数值, 利用低进制转化为高进制时，字符数会减少的特性。多服务场景下可以使用数据库自增id, 或redis。

- 优点: 不会重复
- 缺点: 自增形式生成的短码有序, 存在安全问题。

#### 摘要算法

算法过程：
1. 将长网址md5生成32位签名串, 分为4段, 每段8个字节；
2. 对这四段循环处理, 取8个字节, 将他看成16进制串与0x3fffffff(30位1)与操作, 即超过30位的忽略处理；
3. 这30位分成6段, 每5位的数字作为字母表的索引取得特定字符, 依次进行获得6位字符串；
4. 总的md5串可以获得4个6位串；取里面的任意一个就可作为这个长url的短url地址；

- 优点: 短链长度固定, 非顺序递增, 较为安全
- 缺点: 存在重复可能 

#### 算法选择与实现

考虑常规业务场景, 是不能接受短链重复的, 故采用自增序列算法, 那么主要需要考虑的点有:

- 自增id的实现

    服务通常是多机部署, 自增id可以通过MySQL或/redis来实现, 本次代码实现上, 因未接入redis, 暂使用`AtomicLong`类实现自增。
    
- 自增id的顺序性问题

    通过构造乱序的62进制字母表来处理, 用这个乱序表来编码和解码。

### 链接过期

过期处理方式: 给每个链接打上过期时间戳, 开启一个线程定时处理。

一般短链与长链映射关系存储在持久化数据库(如MySQL)中, 存储资源够用, 另一方面, 如果用户拿了有效短链要找长链却因为过期找不到, 不符合业务场景, 故当前方案不考虑过期。

### 接口设计

短链接的前缀有2种形态:

1. url前缀不变: 如`http://www.baidu.com/gawaga/p/dasfsa.html` -> `http://www.baidu.com/abc`
2. url前缀改变: 如`http://www.baidu.com/gawaga/p/dasfsa.html` -> `http://n-s.fun/abc`

此处尚不明确需求场景, 故使用前缀不变的方式, 对请求参数做简单校验, 实际场景中可以考虑将有效前缀提前加载至内存, 并通过检验过滤掉部分非正常请求。

短域名存储接口:
    长域名简单校验 -> 限流校验 -> 内存获取则直接返回 -> 否则获取10进制自增id -> 转62进制字符 -> 拼接默认占位字符 -> 存储(有缓存机制则加载到缓存) -> 返回短域名。

短域名读取接口:
    短域名简单校验 -> 布隆过滤器判断短链是否存在 -> 存在则获取对应长链返回, 不存在则报错。
    
### 假设

#### 接口被刷

短域名存储接口:
- 前置校验: 一般长域名都是内部服务生成, 可以对长域名进行校验, 过滤非正常请求。
- 缓存策略: 维护部分热点数据(长域名-短域名映射)到缓存, 若有相同长域名, 直接返回生成过的短域名。
- 自增id获取方式优化: 若以MySQL方式获取id, 考虑到MySQL的tps, 可以每次从MySQL获取一段id, 避免每次请求都要请求MySQL。
- 限流策略: 对qps或ip维度的请求量进行限制, 超过上限返回系统繁忙。
- 扩容缩容机制: 若服务器自身压力大, 采取扩容措施。

短域名读取接口:
- 前置校验: 对短域名长度/字符进行简单校验, 过滤非正常请求。
- 布隆过滤器: 过滤掉服务器没有的短链请求。
- 限流策略: 同短域名存储接口。
- 扩容缩容机制: 同短域名存储接口。

## 总结

- 生成短链在实现上采取自增id的方式。
- 使用base62乱序的形式避免短链接顺序递增。
- 短链采用永久有效的方式。
- 针对可能的恶意被刷, 采用请求校验/限流等方式。
- 针对正常qps过高, 采用减少网络IO/限流/扩容的方式。
- 本次作业中, 未接入MySQL/redis, 仅实现接口的基本功能。