# 短域名服务

#### 开发环境

​	JDK8，-Xms512m -Xmx1024m 垃圾回收器采用默认的ParalleNew+CMS



#### 设计思路

##### 	短域名算法

​	**思路一：**压缩算法，因为要求短域名长度不大于8字符，没有一种算法可以把所有字符都压缩到8字节以内，这里不考虑；

​	**思路二：**哈希算法，因为会产生哈希碰撞，这里不作为最佳方案；

​	**思路三：**随机数，KV多之后随机数重复需要循环直到取到不重复的随机数，影响性能这里不作为最佳方案；

​	**思路四：**自增序列+62进制编码，62的8次方足够满足KV的数量要求，算法实现简单效率高，故这里采用该方案。

##### 	映射存储	

​	这里要求映射存储在内存中，首先想到用Map存储键值对。其次考虑到并发安全使用Java并发集合，计数器考虑并发安全使用AtomicLong。

​	由于数据存储在内存中不会被GC回收。假设KV的平均大小在500个字节，1G内存大约存储200万个KV，当存储的数据达到这个值时对象都进入老年代且无法被GC回收，导致频繁的FullGC，CPU飙高，响应时间增长，最终OOM。

​	因为作业中提到需要考虑避免内存溢出，理论上只能增加内存大小以存储更多的数据，但内存不是无限的，在内存固定的假设下可以淘汰部分数据，这里可以选择FIFO或者LRU这样的缓存淘汰策略。

​	

#### 架构设计图

客户端通过http请求访问服务端API,通过Controller层访问Service层。Service包含两个组件Generator和Store。

Generator短域名生成器接口，通过扩展该接口可以实现不同的短域名生成策略，例如自增+62进制、Hash、随机数等；Store是长/短域名映射存储器接口，通过扩展该接口可以时间不同的存储策略，例如JVM内存存储、缓存中间件存储、数据库存储等。通过Spring依赖注入和自动装配的特性可以方便扩展和改变服务的行为。

这里实现了一个基于自增序列+62进制编码的短码生成器Base62Gernerator，和一个基于内存存储，具备并发安全和缓存淘汰策略的映射存储器LruStore。

![](/Users/shycier/Desktop/short-url/doc/设计架构图.jpg)