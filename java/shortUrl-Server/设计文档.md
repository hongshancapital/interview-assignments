# 设计文档

## 背景

## 功能需求

### 实现一个短链接服务

- 短域名存储接口：接受长域名信息，返回短域名信息
- 短域名读取接口：接受短域名信息，返回长域名信息。

### 限制要求

- 短域名长度最大为 8 个字符
- 采用SpringBoot，集成Swagger API文档；
- JUnit编写单元测试, 使用Jacoco生成测试报告(测试报告提交截图)；
- 映射数据存储在JVM内存即可，防止内存溢出；

## 风险收益

### 风险

无

### 收益

无

## 技术方案

### 基本原理

#### 短链接映射关系

短链服务的核心就是构建短链接和长链接的唯一映射关系，依赖到一个高性能、排列组合数量大而且破解难度大的映射标识生成算法。一般要求满足如下：

- 不容易被破解；
- 不能重复；
- 长度尽可能短；

#### 短链接生成算法

- hash算法：容易碰撞
- 全局发号器
  - 基于中间件实现的全局发号器
  - 雪花算法

本服务采用雪花算法+62进制转换，截取低8位实现

###  技术选型

​	基于相关限制考虑，服务采用java1.8+spring boot+Caffeine的实现方案

### 方案设计

#### 数据缓存

​	数据缓存采用Caffeine做本地缓存，底层是基于W-TinyLFU淘汰算法，提供了一个近乎最佳的命中率。最大条目设置为1024*1024

#### 过滤器

​	过滤器分为两层，容器层过滤器，业务层过滤器

- 容器层过滤器

  容器层过滤器过滤与业务无关的特殊情况的请求，主要有两类: ip黑名单，用于限制恶意ip；限流器，用于服务的限流，防止过载导致服务崩溃

- 业务层过滤

  针对请求做业务相关的校验：如必要字段是否未空，长度是否满足，是否符合规范等；

#### 日志数据统计

-  采用UUID生成requestid追踪单个请求
- 在请求处理完成时，自定义线程，以异步化的方式做相关统计处理

#### 部署方案

​	单机部署，集群部署需要额外的手段保证数据一致性，所以后续部署采用了单机部署的方式测试

## 测试计划

### 代码覆盖率

![jacoco覆盖率](.\testResult\jacoco覆盖率.png)

### swagger接口文档

![swagger](.\testResult\swagger.png)

### 测试效果

- 长链接转短连接

![请求效果](.\testResult\请求效果.png)

- 短链接转长链接

  ![短链接转长链接](.\testResult\短链接转长链接.png)

### 压测

#### 长链接转短链接压测

- 按规律生成 1w个不同网址，jmeter读csv文件压测，要求99时延在1s以下，错误率低于0.01%

- 3200个线程，压测10分钟![长链接转短链接压测](.\testResult\长链接转短链接压测.png)



#### 短链接转长连接压测

服务会周期性的将缓存内容写入文件，筛选缓存中的短链接，3200线程，1秒启动，压测结果如下

#### ![短链接转长链接压测](.\testResult\短链接转长链接压测.png)

#### 详细压测报告

参考testResult下压测报告

### 相关问题

- java.net.SocketException: Socket closed  调整jmeter连接时长
- window下端口号冲突：调整端口号范围

## 后续维护和优化

- spring boot默认的web框架阻塞I/O线程模型，可以采用异步化的方式尝试提升服务吞吐量
- 根据实际情况进行参数调优
- 集群方式部署，需要保证数据一致
  - 方案1：单机数据同步
  - 方案2：hash一致性算法关联请求能落到同一台机器

## 问题

Jacoco覆盖率为0的问题：原因未知，通过在其他文件夹重建测试用例就完成了

原因确认：单测的包路径要和服务路径一致