# 需求分析与设计

## 背景

短域名服务主要用于信息推广，常见的场景有短信，邮件推广，社交网络分享。<br/>
短链的原理是：通过短链找到长链（原始链接），然后再重定向到长链地址。

## 需求目标

撰写两个 API 接口:
1. 短域名存储接口：接受长域名信息，返回短域名信息
2. 短域名读取接口：接受短域名信息，返回长域名信息。

## 架构设计
应用架构设计：采用DDD分层架构，总体分为接入层、应用层、领域层、存储层、防腐层<br/>
接入层（interfaces）：提供rest、rpc等多种协议的接入，直接依赖应用层，不直接访问领域层<br/>
应用层（biz）：组装领域层的能力，复杂的业务逻辑都在该层，直接依赖领域层和防腐层<br/>
领域层（domain）:提供领域能力，依赖存储层<br/>
存储层（storage）:提供存储媒介的统一访问接口，屏蔽具体的实现<br/>
防腐层（adapter）:依赖外部的服务（rpc、http），必须在防腐层转换为自己内部的模型<br/>

## 关键点设计

### 短链生成策略

方案1：自增序列算法
* 优点：实现简单且易理解，不会重复
* 缺点：
    * 高并发下，ID生成器的 ID 生成可能会系统瓶颈，所以它的设计就显得尤为重要，实现起来复杂
    * 存在恶意请求，穷举短连接地址风险

算法过程：
1. 为每一个长链接通过发号器生成自增的id，再将其转化为 62 进制
2. 拼接到短链域名后面就得到了最终的短链接

方案2：摘要算法
* 优点：<br/>
    * 实现简单
* 缺点：
    * 哈希碰撞，存在重复可能性，但概率及其低

算法过程：<br/>
1. 将长网址 md5 生成 32 位签名串,分为 4 段, 每段 8 个字节 <br/>
2. 对这四段循环处理, 取 8 个字节, 将他看成 16 进制串与 0x3fffffff(30位1) 与操作, 即超过 30 位的忽略处理 <br/>
3. 这 30 位分成 6 段, 每 5 位的数字作为字母表的索引取得特定字符, 依次进行获得 6 位字符串 <br/>
4. 总的 md5 串可以获得 4 个 6 位串, 取里面的任意一个就可作为这个长 url 的短 url 地址 <br/>

结论：两种方案各有优缺点，这里我们考虑同时支持两种短链的生成策略。具体在实现上，定义短链生成的策略接口，分别提供对应的实现，并通过配置选择，选择具体的实现。
虽然本题主要需要考虑的单机版的实现，后续我们提供分布式生成策略时，只需要实现该接口，切换容易，扩展性强。

###存储方案

在存储方案的选择上，有本地缓存、redis缓存、db存储，虽然本题要求的是使用本地缓存，
但是考虑后续的扩展性，同样定义统一的存储层接口，提供本地缓存的实现，后续想使用redis缓存或者其他存储方式，
只需要提供新的实现类，并在领域层注入响应的实现即可，扩展性强。

* 本地缓存
    短链的存储属于共享资源，需要保证线程安全，同时需要保证短链存储和读取的性能，使用ConcurrentHashMap，可以很好地满足这两个需求