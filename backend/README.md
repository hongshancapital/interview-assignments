# TypeScript Backend Engineer Assignment
# 长短链接转换技术方案

## 需求分析
该需求需要提供两个接口
1. 注册长链接，返回短链接
2. 根据短链接返回长链接

## 核心问题

### 如何保证生成短链接不重复？
这个问题的核心在于短链接生成算法的实现，实现方案大致分为两类。

1. 随机生成类
直接随机生成字符串，或者某种 hash 算法使用长链接作为种子生成字符串。

好处：实现简单。

缺点：不稳定，随着数据量的增大，冲突概率线性增长。

适用场景：数据量较小场景可以使用。

2. 有序生成类

利用时间戳、机器码等数据生成有序字符串。代表算法 “雪花算法”。

好处：稳定，在 8 位字符串使用完毕之前不会发生冲突。

缺点：实现复杂，性能开销较大。

适用场景：高并发，大数据量场景。

### 短链生成具体实现细节：

短链一般由数字和字母组成，数字和大小写字母共 62 个，我们要求短链不超过八位。因此最多可以生成 62^8 个短链。
先采用 “雪花算法” 生成唯一 id, 然后将 id 对 62^8 取模，最后将取模之后的数字转换成 62 进制。就可以得到一个短链。

性能优化：考虑到短链生成需要大量计算，是计算密集型业务，因此采用 C++ 扩展方式来生成短链。

## 流程图
- 短链接

![生成短链接流程](https://s2.loli.net/2023/02/02/nrMWvhwo7C4k63b.jpg)

- 长链接
![获取长连接流程](https://s2.loli.net/2023/02/02/EPDMqwRyxgK7ZVl.jpg)

## 技术选型
1. 数据库选择 Postgres

只从需求出发，整体的数据量会很大。同时考虑到读取量级应该大于写入量级。在从稳定性,内存，读取性能，写入性能四个维度比较之后。选择了 性能稳定、内存占用优秀、读取性能优秀、写入性能一般的 postgres

2. 缓存 redis

数据类型丰富，性能优越，集群部署方便。同时支持 bloom 过滤器。

3. 框架选择 express

轻量级，简洁，适合小型项目开发。

## 业务边界处理
1. 空值访问
如果有人恶意访问空值或者其他异常访问，很容易造成缓存穿透，打爆数据库。
因此需要添加一个 bloom 过滤器保证服务的安全。

2. 重复注册
重复注册的长链接可以直接使用过滤器过滤掉,不必再生成短链接，降低服务器压力。

2. 分布式抢占问题
当多个实例同时写入同一个长链接时，对应的短链接不一样，后写入的会失败，因此缓存更新必须在数据落库之后。

## 扩展性 & 高可用
目前 node 支持两种集群部署方式
1. node 自身支持 cluster，基于 pm2。
2. 基于 k8s 部署。

目前比较流行的是第二种，支持弹性扩容，比较适合目前业务场景。

在部署时需要注意实例数量和 redis 以及数据库集群匹配，避免出现性能瓶颈。

## 单元测试

![单元测试](https://s2.loli.net/2023/02/02/u5XA8xKESjLVkyw.png)