- [一、背景/目标](#一背景目标)
- [二、需求分析](#二需求分析)
- [三、架构设计](#三架构设计)
  - [3.1 系统设计](#31-系统设计)
  - [3.2 关键点设计](#32-关键点设计)
- [四、详细设计](#四详细设计)
  - [4.1 存储设计](#41-存储设计)
    - [4.1.1 DB](#411-db)
    - [4.1.1 Redis](#411-redis)
  - [4.2 接口设计](#42-接口设计)
- [五、安全生产设计](#五安全生产设计)
  - [5.1 监控告警](#51-监控告警)
- [六、单元测试](#六单元测试)
- [七、集成测试](#七集成测试)
> 第一次用这套框架写服务端，看了下文档就开始写了，大部分地方非常粗糙，有机会的话需要寻找一下最佳实践
## 一、背景/目标
- **撰写两个API接口**  
  - 短域名存储接口：接受长域名信息，返回短域名信息  
  - 短域名读取接口：接受短域名信息，返回长域名信息
- **限制**  
  - 短域名长度最大为 8 个字符（不含域名）  
## 二、需求分析
- 长短域名转换规则  
  - 短域名最大8字符  
  - 长短域名一一对应  
  - 短域名不可被推测（需求并未体现，常理应该保证）  
- 长短域名存储  
  - 短期看DB够用，无需缓存  
  - 需要借助缓存加锁解决并发问题（从下方具体方案中解析出来）  
- 安全生产  
  - 接口成功率（无特殊要求，统计最基础的数据）  
## 三、架构设计
### 3.1 系统设计
![设计图](https://i.328888.xyz/2023/02/23/x89vc.png "")
### 3.2 关键点设计
- 长短域名转换规则（结合两种算法）  
  - 使用DB自增id解决长短域名一一对应问题  
  - 将自增id使用自定义映射规则转换为62进制  
    - 解决短域名可被推测问题，拿不到映射关系，就无法推测  
    - 解决短域名最大8字符问题，62的8次方，足够用  
- 接口并发调用问题（当前方案分析读写不分离场景下，读写分离需要额外考虑，能通过逻辑解决就不加锁，能用缓存锁就不用数据库锁）  
  - 短域名存储接口在长域名相同的情况下并发调用  
    - 背景：一次请求要经过下面三阶段  
    1、select库，得到库中并无此域名  
    2、insert库，获取到自增id  
    3、自增id通过转换算法得到短域名update库  
    场景1：长域名相同的两个请求同时经过了阶段1，判断库中无此域名，导致后面操作冲突  
    解决办法：最简单的办法，加redis锁，key为长域名（比较简单，不是唯一的办法）  
    场景2：长域名相同的两个请求A，B，A通过了阶段2，还未执行阶段3，此时B执行阶段1，会查询到长域名记录，但是短域名为空  
    解决办法：通过业务逻辑解决，短域名为空的情况下，重新调用算法生成一下短域名  
## 四、详细设计
### 4.1 存储设计
#### 4.1.1 DB
```
CREATE TABLE `host_map`(
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `host_long` varchar(256) NOT NULL DEFAULT "" COMMENT '长域名',
  `host_short` varchar(256) NOT NULL DEFAULT "" COMMENT '短域名',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否逻辑删除：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY idx_host_long(host_long),
  KEY idx_host_short(host_short)
) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci comment '长短域名映射表';
```
#### 4.1.1 Redis
```
key:"长域名"
value:"随意"
```
### 4.2 接口设计
![接口](https://i.328888.xyz/2023/02/23/x8LIo.png "")
![接口](https://i.328888.xyz/2023/02/23/x8MdN.png "")
## 五、安全生产设计
### 5.1 监控告警  
接口成功率(埋点查看正常返回) < 99.9%时报警  
## 六、单元测试
时间有限，没有写更细粒度的方法测试  
![接口](https://i.328888.xyz/2023/02/23/x8a2d.png "")

## 七、集成测试
时间有限，只写了冒烟用例  
![接口](https://i.328888.xyz/2023/02/23/x8PuV.png "")
