# 短域名

## 设计要点

### 短连接唯一性
采用 hashids + 数据库自增键生成短域名，32 位 int 范围内 hashids 生成的id最大为 7 个字符，数据库自增键保证短域名的唯一性。
### 读取
增加读取缓存
### 写入
增加 url hash 的索引,保证在写入时能快速查找是否已存在相同 url 的短域名

## 方案简介
hashids 是类似 base64 的数字到字符串的编码方式,相对于 base64 有以下优点:
- 可以自定义字符集
- 可以设置salt来增加破解难度(salt用来打乱字符集)
- 可以设置填充,用来生成大于固定长度的字符串

所以短网址的生成采用了 mysql 自增主键 + hashids 的方式生成

自增主键在并发插入时可能有性能问题,但是考虑到短网址一般读远大于写,所以暂时没有考虑这个问题

写入是增加了 md5 检查,如果已存在相同的 url 则不再插入,同时考虑到 md5 碰撞问题,允许 md5 重复,重复后再检查 url 是否完全仙童

读取通过增加一层缓存来提高性能

## 技术栈
 - mysql - 持久化
 - redis - 缓存

## 数据库设计
 - id int auto_increment primary key
 - url varchar(5000)
 - url_hash binary(16) index
 - create_time timestamp

## 方案存在的缺陷
1. 如果 hashids 的 salt 泄漏, 那么短域名就可以被猜出来, 且无法方便的更换


## TODO
 - [x] id生成
 - [x] 缓存
 - [x] 数据访问
 - [x] 控制器
 - [x] App
 - [x] 环境配置
 - [x] 集成测试
 - [x] 参数校验
