## 前置准备

需要本地有 mysql redis node环境，注意 redis 需要安装了 redis-bloom 插件。

如果有 docker 环境可以使用 redis-bloom 镜像 `docker run -p 6379:6379 --name redis-redisbloom redislabs/rebloom:latest`

nodejs 版本使用 16 以上，推荐 18 以上

## 本地测试

`npm install` 之后使用 `npm run start` 启动，默认使用 3000 端口。

配置参考 .env 文件

```env
PORT=3000 # 监听端口

SALT=shortlink # hashids 的 salt
URL_LENGTH=8182 # 接收的最大 url 长度

DB_HOST=127.0.0.1 # 数据库 host	
DB_USER=shortlink # 数据库用户
DB_PASS=shortlink # 数据库密码
DB_NAME=shortlink # 数据库名字

REDIS_URL=redis://127.0.0.1:6379 # redis 的 url
```

## docker 发布

使用 `docker build .-t shortlink` 命令构建镜像

.env 相关的环境参数可以通过 -e 配置写到环境变量里

`docker run -p 3000:3000 shortlink` 启动镜像

## 接口说明

### 生成短连接接口

```json
POST localhost:3000/shortlink
request
body application/json
{
	"url":"http://baidu.com"
}
response application/json
{
    "hash": "EywAn"
}
errors
{
    "error": "please send correct url"
}
```

### 获取短连接接口

```json
GET localhost:3000/shortlink?hash=EywAn
response application/json
{
    "url": "http://juejin.cn/post/70017291391661506692"
}
errors 
{
    "error": "hash not exist"
}
{
    "error": "wrong hash"
}
```

## 数据表

```sql
CREATE TABLE `shortlinks` (
  `id` int unsigned NOT NULL AUTO_INCREMENT, # 自增 id
  `hash` varchar(10) COLLATE utf8mb4_general_ci DEFAULT NULL, # 生成的 hash
  `domain` varchar(300) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL, # 域名
  `path` varchar(8182) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL, # path 路径
  `domain_crc32` bigint NOT NULL, # domain 的 crc32 方便索引
  `path_crc32` bigint NOT NULL, # path 的 crc32 方便索引
  PRIMARY KEY (`id`), # 主键
  KEY `shortlink_crc32` (`domain_crc32`,`path_crc32`) # 联合索引加快查找速度
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

