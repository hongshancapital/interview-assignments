## 需求分析

按照要求划分功能点，并对每个功能点做分析，确定需求目的和实现方式

### 功能1：应用运行在AWS的ECS Fargate中

Fargate是AWS推出的一种无需关注基础设施的容器化部署方式

鉴于Fargate本质上仍是容器运行，本例需要使用容器镜像仓库存放镜像，以便Fargate实例在启动时拉取

需要根据应用项目的实际情况，编写适合示例代码的dockerfile文件，使编译后的可执行应用转换成容器镜像。

使用的示例代码为自行编写的springboot演示程序

本期先实现单容器实例运行

### 功能2：开发人员的源代码更改合并到main分支之前，自动运行单元测试(如果使用本仓库的Java工程，则使用maven执行测试命令)；

为防止代码不经审查就合并到关键分支上从而给后续的开发及上线带来风险，GitHub采用pull request方式管理代码合并操作，可设置保护分支，要求代码在合并到保护分支之前必须发起pull request。而未保护分支一般认为可以随意向分支上push代码。

在本例中main分支是关键分支，也是受保护分支，因此“合并到main分支之前自动运行单元测试”，就意味着必须在pull request批准前就进行单元测试。

为自动运行单元测试，需要使用自动化机制，监听代码的变动及事件，监听到pull request批准前的事件，并且触发运行单元测试。

基于管理左移的角度，决定监听push事件，为防止和后面的main分支push事件重复，监听时需忽略main分支上的push事件。结合一般团队开发的代码管理方式，本项目中限制监听以“feature_”为分支名开头的分支，因该类分支一般为功能特性汇总分支，该分支上的代码适合运行单元测试并可对测试结果进行度量或者进行后续流程限制。

### 功能3：通过AWS CDK或AWS SDK创建应用所需的基础架构和所需的服务，包括VPC、ECS、Task Define、Service，使用AWS CloudWatch管理日志；

要运行Fargate，需要定义VPC、CLUSTER、SECURITYGROUP、TASKDEFINITION、SERVICE等基础设施，此外还需要定义私有镜像库ECR

AWS SDK无法定义Fargate所需所有基础架构，因此考虑使用CDK进行Fargate的定义，因CDK也可在CloudWatch中定义日志组，故考虑本项目的aws基础设施全部使用CDK进行定义。

### 功能4：应用程序部署是自动化的，可以使用Jenkins、AWS Code Deploy、Github Action；

部署自动化，意味着代码的编译打包、生成应用镜像并推送至镜像库、运行/更新容器实例的全过程均为自动进行

除了过程自动之外，触发时机也需要自动，一般而言自动触发分为定时触发和事件触发，将部署与代码管理流程相结合，选择在代码合并到main上之后触发部署

本期选择使用GitHub Action实现部署自动化，GitHub Action中自带了部署到AWS ECS的功能，触发条件为main分支被push（因受保护分支的push一定在pr被批准后）。

需说明的是，GitHub Action部署ECS的功能，需要使用json格式定义的TaskDefinition，不能直接使用CDK或SDK，会增加部署复杂度，后续应考虑更简单的自动化执行手段。

部署步骤分为：程序编译打包，制作docker容器镜像，上传至镜像仓库，更新taskdefinition，部署

### 功能5：监控CloudWatch中的应用日志，当出现ERROR关键字时通过AWS SNS发送邮件告警；

在CloudWatch中定义一个日志组（LogGroup）并在运行环境定义中与运行容器进行绑定，在上面增加一个基于日志内容的指标筛选（MetricFilter），按照日志中出现“ERROR”时，指标值为1

定义一个报警（Alarm），取10秒为一个统计周期，1个周期内指标累计值大于等于1时，触发报警

同时定义一个通知主题（Topic），指定一个邮箱订阅此主题，并且和报警绑定，当报警触发时，通过该主题向邮箱发送电子邮件。